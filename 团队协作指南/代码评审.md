代码评审，又称代码审查，是软件开发流程中必不可少的一环。

> 代码审查是计算机源代码的系统性检验（有时被称为同行评审）。其目的在于找到开发初期所忽略的错误，从而提高软件的整体质量。
>
> <div data-type="alignment" data-value="right" style="text-align:right">
>   <div data-type="p">——Wikipedia</div>
> </div>

## 为什么要代码评审

代码评审并不意味着被评审者的能力不足。有下面这些原因表明代码评审的重要性。

### 降低风险

写出存在 bug 的代码再正常不过了。每个人贡献的代码先要经过持续集成（CI，Continuous Integration）的一系列构建测试，然后是人工代码审查，因此代码审查可以说是最后一道防线。

### 显著提高代码质量

代码评审不仅仅是单纯地查找 bug 或是修正格式问题，还包括使代码更高效。

在一个团队里，每个人都有自己的背景和特长，因此总有人可能提出更聪明的解决方案，更合适的设计模式，或者能降低复杂性或提高性能的方法。

### 有助于熟悉项目

当一个团队在做一个项目时，想要每个开发人员致力于应用的每个部分，这是极不可能的。有时候，会出现这种情况：在某一段时间，一个开发人员正为项目的大部分模块辛苦地工作，而另一个人则完全在做别的东西。

### 知识共享

通过合作，每个人都可以相互学习并取得进步。提交代码者很有可能从该工作中得到反馈，并意识到可能存在的问题和需要改进的部分；而审查者也可以通过阅读他人代码学到新的东西，并找出适用于他们自己的工作方案。

## 如何进行代码评审

### 发起代码评审

代码评审发生在 Pull Request 阶段，代码提交者可以请求其他成员的 Review，如下图所示。

![image.png | left | 747x456](https://cdn.yuque.com/yuque/0/2018/png/125564/1531619202440-1de6c942-cf5f-4a87-8cba-6939f9550723.png)

然后被请求进行评审的成员打开这条 Pull Request 页面时会出现一个提示框：

![QQ20180714-212427@2x.png | center | 747x492](https://cdn.yuque.com/yuque/0/2018/png/125564/1531619279909-ce317eea-2d87-4824-be9f-42972de5e1a4.png)

我们点击 Add your review 按钮，即进入到 Review 页面（或者也可以点击 Files changed 这个 Tab）。Review 页面展示了本次 Pull Request 所有发生改动的文件，评审的过程也就是审查这些发生改动的代码。

### 在 GitHub 上评审

直接在 GitHub 的 Pull Request 页面评审是最基本的方法。对于改动比较小的分支，这种方法完全足够。

有时候我们发现了他人代码的问题。千万不要保留你的意见！要把自己的想法有条理地写下来。我们可以选择特定一行来发表评论，只需把鼠标移到行首，就会显示一个加号，如下图。

![image.png | center | 500x101.43769968051119](https://cdn.yuque.com/yuque/0/2018/png/125564/1531619674873-fac8a6f4-1cc9-48f8-a663-f047368c225d.png)

点击加号，就可以对这一行进行评论了：

![image.png | center | 500x255.25040387722132](https://cdn.yuque.com/yuque/0/2018/png/125564/1531619746746-3c2f6e6e-4b38-43c7-a9a9-b7b59e6be096.png)

### 拉取到本地评审

有时候某些分支的改动非常大，大到需要你在本地亲自运行一下，看看是否真的达到了预期的目标。

```bash
$ git fetch origin lots-of-changes
$ git checkout logs-of-changes
```

然后你的本地仓库就完成切换到待评审分支的状态了！你可以试着运行，做各种尝试，还可以在自己熟悉的编辑器里面更加舒适地阅读代码，美滋滋。

### 提交评审结果

无论是直接在 GitHub 还是在本地审查，最后都要提交评审结果。评审结果包括你在代码行中的所有评论、Review summary 和最终意见。

Review summary 主要是一些总结性的话语。如果代码提交者确实做得非常优秀，当然是要夸奖一下喔；如果有些地方做得不足，则要给出改进的方向和一些鼓励。

最终意见有以下三种：

- Comment：只是做一些客观评价，对此分支是否可以合并不给出明确意见
- Approve：同意此分支合并进主分支
- Request changes：不同意此分支合并，需要进一步修改

![image.png | left | 747x299](https://cdn.yuque.com/yuque/0/2018/png/125564/1531620325289-0ff8d283-c3b0-4777-a21e-b69aea254586.png)

接着代码提交者根据其他人的评审进行修改后提交，然后再继续评审，如此迭代，直到分支可以合并。

## 最佳实践

### 对于代码提交者

#### 任务最小化

每个开发任务都应当只做一件事情，因此所需评审的代码应可能地少。事实表明，超过 200 行的代码评审的有效性显著降低，超过 400 行时代码评审几乎没有意义。

#### 提供足够的上下文

在编写代码时应有意识地添加足够的注释或文档，因为你的代码会被很多人阅读。良好的注释能够让团队其他成员评审你的代码时更加轻松，也更容易发现问题所在。另外，在填写 Pull Request 说明信息时，也应该将所解决的问题、发生的相应改变说明清楚。

### 对于评审者

#### 评审最重要的事情

不要纠结于代码风格或是格式问题，这些事情会有专门的工具代劳。你应当关注的是下面这些问题：

- 代码是否具备良好的可读性？
- 能否实现得更简洁、更地道？
- 代码是否遵循了良好的设计原则？
- 代码的空间效率和时间效率怎么样？

#### 保持积极开放的心态

不必过于挑剔，乐于赞扬他人的劳动，学会欣赏他人的代码。
